require 'rubygems'
require 'bundler/setup'

require 'chronic'
require 'fileutils'
require 'rake'

$LOAD_PATH.unshift File.expand_path(File.join(File.dirname(__FILE__), %w[lib]))

require 'pike/application'
require 'pike/models'
require 'pike/version'

namespace :mongo do

  desc 'Run MongoDB'
  task :run do |task|
    system("clear && bundle exec mongod run --rest --quiet --config #{File.join(File.dirname(__FILE__), %w[mongod.conf])}")
  end

end

namespace :pike do

  desc 'Create pike console'
  task :console do |task|
    system("clear && bundle exec ruby_app console")
  end

  desc 'Run pike'
  task :run do |task|
    system("clear && bundle exec ruby_app run")
  end

  desc 'Run pike w/ coverage report'
  task :coverage do |task|
    system("clear && rm -rf coverage && bundle exec rcov --include $PATH --exclude bin,gems ruby_app -- run && open coverage/index.html")
  end

  desc 'Dump pike database'
  task :dump do |task|
    system("rm -rf dump && bundle exec mongodump --db pike --out dump && tar -czf dump.tgz dump && rm -rf dump")
  end

  desc 'Restore a dumped pike database'
  task :restore do |task|
    system("rm -rf dump && tar -xzf dump.tgz && bundle exec mongorestore --db pike --drop dump/pike &&  rm -rf dump")
  end

  desc 'Drop pike database'
  task :drop do |task|
    Pike::Application.create_default!
    Pike::Application.drop_database!
  end

  desc 'Get pike version'
  task :version do |task|
    puts Pike::VERSION
  end

  namespace :development do

    desc 'Update pike version, commit, and push to origin'
    task :push, :version do |task, arguments|
      version_file = File.join(Pike::ROOT, %w[lib pike version.rb])
      system "sed 's|[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*|#{arguments.version}|g' < '#{version_file}' > '#{version_file}.out' && rm '#{version_file}' && mv '#{version_file}.out' '#{version_file}' && git commit --all --message='Incrementing version' && git push origin development"
    end

  end

  namespace :identities do

    desc 'Print all identities'
    task :print_all do |task|
      Pike::Application.create_default!
      Pike::Identity.all.each do |identity|
        puts "identity.user.url=#{identity.user.url.inspect}, identity.expires=#{identity.expires}"
      end
    end

    desc 'Expire all identities'
    task :expire_all do |task|
      Pike::Application.create_default!
      Pike::Identity.all.each do |identity|
        identity.expires = Chronic.parse('yesterday')
        identity.save!
      end
    end

  end

  namespace :test do

    desc 'Run feature tests for the given feature file or all features files if no argument is provided'
    task :features, :file do |task, arguments|
      if arguments.file
        system("bundle exec cucumber --format pretty --tags ~@broken --require features '#{arguments.file}'")
      else
        system("bundle exec cucumber --format pretty --tags ~@broken --require features")
      end
    end

    desc 'Run RSpec tests'
    task :specs, :file, :line do |task, arguments|
      if arguments.file
        if arguments.line
          system("bundle exec rspec #{arguments.file} --line_number=#{arguments.line} --format=documentation --colour")
        else
          system("bundle exec rspec #{arguments.file} --format=documentation --colour")
        end
      else
        system("bundle exec rspec spec/ --format=documentation --colour")
      end
    end

    desc 'Run all tests'
    task :all => ['test:specs',
                  'test:features']

  end

end

