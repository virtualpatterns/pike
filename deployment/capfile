require 'rubygems'
require 'bundler/setup'
require 'bundler/capistrano'

require 'railsless-deploy'

set :application, 'Pike'
set :repository,  'git@github.com:virtualpatterns/pike.git'

set :scm, :git
set :scm_username, 'virtualpatterns'

set :deploy_to, '/var/www/pike'

set :stages, %w[production staging]
set :default_stage, 'staging'
require 'capistrano/ext/multistage'

namespace :pike do

  desc 'Start the application'
  task :start, :roles => :app do
    run 'cd /var/www/pike/current && thin --daemonize --port 8008 --rackup config.ru start'
  end

  desc 'Stop the application'
  task :stop, :roles => :app do
    run 'cd /var/www/pike/current && thin stop'
  end

  desc 'Update the application'
  task :update, :roles => :app do
    find_and_execute_task('pike:stop')
    find_and_execute_task('deploy:update')
    find_and_execute_task('bundle:install')
    find_and_execute_task('pike:start')
  end

end
